# Redis Listener

This repository includes the source and configuration files for an executable that subscribes to Redis [keyspace notifications](https://redis.io/topics/notifications) and passes the data to a Lambda Function. 

## Requirements
This service is written in [golang](https://golang.org/). To build the service, clone this repository, and in the redis-listener-blog folder type: 'go build'.

## How it works
The service is an example of how to handle Redis [hashes](https://redis.io/commands#hash). It's designed to pass a Lambda function an object with three data fields:

	Id       string json:"id"
	Obj_Name string json:"obj_name"
	Body     string json:"body"

The `Id` field is a GUID generated by the service code, the `obj_name` is the name of the hash element created by the Redis `HSET` command. 

## Configuration 
The service requires some configuration to work:
### Environment Variables
The environment variables are stored in the `env.sh` file. To apply them type `source env.sh` in the terminal. 
The environment variables are:

**`REDIS_MASTER_HOST`**= (The endpoint of your Redis cluster)

**`REDIS_MASTER_PORT`**=`6379` (The port of the Redis cluster, typically 6379)

**`AWS_ACCESS_KEY_ID`**= (The AWS access ID for the identity used to run the Lambda Function)

**`AWS_SECRET_ACCESS_KEY`**= (The AWS secret access key for the identity used to run the Lambda Function)

**`AWS_DEFAULT_REGION`**= (The AWS region where the Lambda Function is hosted, e.g. `us-west-2`)

**`REDIS_SUB_CHANNEL`**=`__key*__:*` (the pattern of keys used for the Keyspace Notification)

**`META_MAP_SUFFIX`**=`__meta_record__` (the suffix of the hash keys used to store mapping between hashes and Lambda Functions)

**`SUPPORTED_COMMANDS`**=`hset` (the Redis commands to be processed, in this example, only [`hset`](https://redis.io/commands/hset) is supported)

### Function mapping (functionCfg)
The `functionCfg` file contains the mapping between Redis keys and Lambda Function. The data from the file is read into a hash key and used every time a new hash field is added or changed to call a Lmabda function. 

#### The format is:

key name (hash key name, should start with prefix defined in the META_MAP_SUFFIX environment variable, default is `__meta_record__`)|`name` (constant), value of name field (repeat of key name),  `pattern` (constant), value of pattern (the pattern of the hash key name to be processed, the '*' value means all keys), `lambda` (constant), lambda arn (the AWS Resource Name of the Lambda function called)

##### Example:
`__meta_record__Dynamo|name, __meta_record__Dynamo, pattern, *, lambda, arn:aws:lambda:us-west-2:00000:function:go-dynamo`



